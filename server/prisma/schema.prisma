// AAA Deep Master Relational Schema (Restoring Monsters)
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            Int      @id @default(autoincrement())
  username      String   @unique
  password      String
  gold          Int      @default(0) 
  vitality      Int      @default(100)
  maxVitality   Int      @default(100)
  lastVitalityUpdate DateTime @default(now())
  maxInventorySlots Int    @default(20)
  currentRegion Int      @default(1)
  region        RegionTemplate @relation(fields: [currentRegion], references: [id])
  
  tavernTimeSecondsToday Int      @default(0)
  lastTavernResetAt      DateTime @default(now())
  lastQuestResetAt       DateTime @default(now())
  tavernEntryAt          DateTime?
  isInTavern             Boolean  @default(false)

  premiumTierId Int      @default(0)
  premiumTier   PremiumTierTemplate @relation(fields: [premiumTierId], references: [id])
  
  guildId       Int?
  guild         Guild?   @relation(fields: [guildId], references: [id])

  heroes        Hero[]
  inventory     InventoryItem[]
  listings      MarketListing[]
  ledger        TransactionLedger[]
  activeQuests  UserQuest[]
  receivedMail  Mail[]   @relation("ReceiverRelation")
  notifications Notification[]
  formationPresets FormationPreset[]
  taskQueue     TaskQueue[]
  recipes       UserRecipe[]
}

model MonsterTemplate {
  id           Int      @id
  name         String
  hp_base      Int
  damage_base  Int
  behaviorTree String   @default("SimpleAI") // Nama file JSON di folder bt/
  categoryId   Int
  category     MonsterCategory @relation(fields: [categoryId], references: [id])
  loot         MonsterLootEntry[]
  regions      RegionMonster[]
}

model MonsterCategory {
  id        Int      @id
  name      String
  monsters  MonsterTemplate[]
}

model MonsterLootEntry {
  id          Int      @id @default(autoincrement())
  monsterId   Int
  monster     MonsterTemplate @relation(fields: [monsterId], references: [id])
  itemId      Int
  chance      Float
}

model Notification {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  type        String
  message     String
  createdAt   DateTime @default(now())
}

model ItemTemplate {
  id              Int      @id
  name            String
  description     String
  category        String   @default("EQUIPMENT")
  baseValue       Int      @default(10)
  rarity          String   @default("COMMON")
  isTwoHanded     Boolean  @default(false)
  traits          ItemTrait[]
  equipSlots      ItemEquipSlot[]
  stats           ItemStat[]
  instances       InventoryItem[]
  marketListings  MarketListing[]
  recipeResult    RecipeTemplate[]
  ingredients     RecipeIngredient[]
  regionResources RegionResource[]
  taskTargets     TaskQueue[]
}

model RegionTemplate {
  id              Int      @id
  name            String
  description     String
  visualType      String   @default("TOWN")
  type            RegionType @relation(fields: [visualType], references: [id])
  dangerLevel     Int      @default(1)
  metadata        String   @default("{}") 
  connections     RegionConnection[] @relation("OriginRegion")
  connectedFrom   RegionConnection[] @relation("TargetRegion")
  resources       RegionResource[]
  monsters        RegionMonster[]
  travelOrigins   TaskQueue[] @relation("TaskTravelOrigin")
  travelTargets   TaskQueue[] @relation("TaskTravelTarget")
  tavernMercenaries TavernMercenary[]
  residents       User[]
}

model RegionMonster {
  id          Int      @id @default(autoincrement())
  regionId    Int
  region      RegionTemplate @relation(fields: [regionId], references: [id])
  monsterId   Int
  monster     MonsterTemplate @relation(fields: [monsterId], references: [id])
}

model RegionType {
  id          String   @id // e.g. "VOLCANO"
  name        String   // Display Name
  description String?
  regions     RegionTemplate[]
  effects     TerrainEffect[]
}

model TerrainEffect {
  id            Int      @id @default(autoincrement())
  regionTypeId  String
  regionType    RegionType @relation(fields: [regionTypeId], references: [id])
  effectType    String   // BURN, SLOW, HEAL, DRAIN, NO_MANA
  chance        Float    @default(1.0) // 0.0 to 1.0
  power         Float    @default(0)
  statKey       String?  // e.g. "speed"
  statValue     Float?   // e.g. -0.3
  tickInterval  Int      @default(1)
}

model TavernMercenary {
  id              Int      @id @default(autoincrement())
  heroId          Int      @unique
  hero            Hero     @relation(fields: [heroId], references: [id])
  regionId        Int
  region          RegionTemplate @relation(fields: [regionId], references: [id])
  recruitmentCost Int      @default(100)
  expiresAt       DateTime 
}

model RegionConnection {
  id              Int      @id @default(autoincrement())
  originRegionId  Int
  origin          RegionTemplate @relation("OriginRegion", fields: [originRegionId], references: [id])
  targetRegionId  Int
  target          RegionTemplate @relation("TargetRegion", fields: [targetRegionId], references: [id])
  travelTimeSeconds Int    @default(15)
}

model RegionResource {
  id              Int      @id @default(autoincrement())
  regionId        Int
  region          RegionTemplate @relation(fields: [regionId], references: [id])
  itemId          Int
  item            ItemTemplate   @relation(fields: [itemId], references: [id])
  gatherTimeSeconds Int    @default(10)
}

model ItemTrait {
  id              Int      @id @default(autoincrement())
  itemId          Int
  item            ItemTemplate @relation(fields: [itemId], references: [id])
  traitId         Int
  trait           TraitTemplate @relation(fields: [traitId], references: [id])
}

model TraitTemplate {
  id              Int      @id
  name            String
  description     String   @default("")
  category        String   @default("GENERAL")
  items           ItemTrait[]
  heroes          HeroTrait[]
}

model ItemEquipSlot {
  id              Int      @id @default(autoincrement())
  itemId          Int
  item            ItemTemplate @relation(fields: [itemId], references: [id])
  slotKey         String   
}

model ItemStat {
  id              Int      @id @default(autoincrement())
  itemId          Int
  item            ItemTemplate @relation(fields: [itemId], references: [id])
  statKey         String
  statValue       Float
}

model RecipeTemplate {
  id              Int      @id
  name            String
  description     String
  resultItemId    Int
  resultItem      ItemTemplate @relation(fields: [resultItemId], references: [id])
  craftTimeSeconds Int     @default(30)
  ingredients     RecipeIngredient[]
  learnedBy       UserRecipe[]
}

model RecipeIngredient {
  id              Int      @id @default(autoincrement())
  recipeId        Int
  recipe          RecipeTemplate @relation(fields: [recipeId], references: [id])
  itemId          Int
  item            ItemTemplate   @relation(fields: [itemId], references: [id])
  quantity        Int
}

model UserRecipe {
  id            Int      @id @default(autoincrement())
  userId        Int
  user          User     @relation(fields: [userId], references: [id])
  recipeId      Int
  recipe        RecipeTemplate @relation(fields: [recipeId], references: [id])
  @@unique([userId, recipeId])
}

model Hero {
  id          Int      @id @default(autoincrement())
  userId      Int?     
  user        User?    @relation(fields: [userId], references: [id])
  name        String
  level       Int      @default(1)
  classId     Int      
  combatClass ClassTemplate @relation(fields: [classId], references: [id])
  jobId       Int?
  job         JobTemplate? @relation(fields: [jobId], references: [id])
  vitality    Int      @default(100)
  equipment   HeroEquipment[]
  formationSlots FormationSlot[]
  taskQueue     TaskQueue[]
  traits        HeroTrait[]
  tavernEntry   TavernMercenary?
}

model ClassTemplate {
  id              Int      @id
  name            String
  heroes          Hero[]
}

model JobTemplate {
  id              Int      @id
  name            String
  category        String   @default("COLLECTION")
  workers         Hero[]
}

model TaskQueue {
  id              Int      @id @default(autoincrement())
  userId          Int
  user            User     @relation(fields: [userId], references: [id])
  heroId          Int?
  hero            Hero?    @relation(fields: [heroId], references: [id])
  type            String   
  targetItemId    Int?
  targetItem      ItemTemplate? @relation(fields: [targetItemId], references: [id])
  originRegionId  Int?
  originRegion    RegionTemplate? @relation("TaskTravelOrigin", fields: [originRegionId], references: [id])
  targetRegionId  Int?
  targetRegion    RegionTemplate? @relation("TaskTravelTarget", fields: [targetRegionId], references: [id])
  status          String   @default("PENDING")
  startedAt       DateTime?
  finishesAt      DateTime?
}

model FormationPreset {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  name        String   
  slots       FormationSlot[]
}

model FormationSlot {
  id          Int      @id @default(autoincrement())
  presetId    Int
  preset      FormationPreset @relation(fields: [presetId], references: [id])
  heroId      Int
  hero        Hero     @relation(fields: [heroId], references: [id])
  gridX       Int      
  gridY       Int      
  @@unique([presetId, gridX, gridY])
  @@unique([presetId, heroId])
}

model HeroEquipment {
  id          Int      @id @default(autoincrement())
  heroId      Int
  hero        Hero     @relation(fields: [heroId], references: [id])
  slotKey     String
  itemInstanceId Int      @unique
  itemInstance   InventoryItem @relation(fields: [itemInstanceId], references: [id])
}

model InventoryItem {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  templateId  Int
  template    ItemTemplate @relation(fields: [templateId], references: [id])
  quantity    Int      @default(1)
  marketListing MarketListing?
  equippedIn    HeroEquipment?

  @@unique([userId, templateId]) // NEW: Unique constraint for easier stacking
}

model MarketListing {
  id              Int      @id @default(autoincrement())
  sellerId        Int
  seller          User     @relation(fields: [sellerId], references: [id])
  templateId      Int
  itemTemplate    ItemTemplate @relation(fields: [templateId], references: [id])
  itemInstanceId  Int      @unique
  itemInstance    InventoryItem @relation(fields: [itemInstanceId], references: [id])
  pricePerUnit    Int
  expiresAt       DateTime
}

model QuestTemplate {
  id              Int      @id
  name            String
  description     String
  objectives      QuestObjective[]
  rewards         QuestReward[]
  userQuests      UserQuest[]
}

model QuestObjective {
  id              Int      @id @default(autoincrement())
  questId         Int
  quest           QuestTemplate @relation(fields: [questId], references: [id])
  type            String   
  targetId        Int      
  amount          Int      @default(1)
  description     String
}

model QuestReward {
  id              Int      @id @default(autoincrement())
  questId         Int
  quest           QuestTemplate @relation(fields: [questId], references: [id])
  type            String   
  amount          Int      @default(1)
}

model UserQuest {
  id            Int      @id @default(autoincrement())
  userId        Int
  user          User     @relation(fields: [userId], references: [id])
  questId       Int
  quest         QuestTemplate @relation(fields: [questId], references: [id])
  status        String   @default("ACTIVE")
}

model Mail {
  id              Int      @id @default(autoincrement())
  receiverId      Int
  receiver        User     @relation("ReceiverRelation", fields: [receiverId], references: [id])
  subject         String
  expiresAt       DateTime
}

model HeroTrait {
  id              Int      @id @default(autoincrement())
  heroId      Int
  hero            Hero     @relation(fields: [heroId], references: [id])
  traitId     Int
  trait       TraitTemplate @relation(fields: [traitId], references: [id])
}

model Guild {
  id              Int      @id @default(autoincrement())
  name            String   @unique
  templateId      Int
  template        GuildTemplate @relation(fields: [templateId], references: [id])
  vaultGold       Int      @default(0)
  members         User[]
  facilities      GuildFacility[]
  perks           GuildPerk[]
}

model GuildTemplate {
  id              Int      @id
  name            String
  guilds          Guild[]
}

model GuildFacility {
  id              Int      @id @default(autoincrement())
  guildId         Int
  guild           Guild    @relation(fields: [guildId], references: [id])
  facilityKey     String
  level           Int      @default(1)
}

model GuildPerk {
  id              Int      @id @default(autoincrement())
  guildId         Int
  guild           Guild    @relation(fields: [guildId], references: [id])
  perkKey         String
  level           Int      @default(1)
}

model Siege {
  id              Int      @id @default(autoincrement())
  regionId        Int
  attackerGuildId Int
  status          String   @default("PENDING")
}

model SiegeLog {
  id              Int      @id @default(autoincrement())
  siegeId         Int
  event           String
}

model TransactionLedger {
  id            Int      @id @default(autoincrement())
  userId        Int
  user          User     @relation(fields: [userId], references: [id])
  type          String   
  currencyTier  String   
  amountDelta   Int      
  newBalance    Int      
  metadata      String   @default("{}") 
  createdAt     DateTime @default(now())
}

model PremiumTierTemplate {
  id              Int      @id
  name            String   
  queueSlots      Int      @default(0)
  speedBonus      Float    @default(0.0)
  vitalityRegenMult Float @default(1.0)
  maxVitalityBonus Int @default(0)
  users           User[]
}
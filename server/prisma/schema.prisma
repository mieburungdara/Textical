// AAA 5-Tier Currency Master Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. CORE USER & ACCOUNT
// ==========================================
model User {
  id            Int      @id @default(autoincrement())
  username      String   @unique
  password      String
  
  // 5-TIER CURRENCY SYSTEM
  copper        Int      @default(0)
  silver        Int      @default(0)
  gold          Int      @default(5)   // Starting with 5 Gold
  platinum      Int      @default(0)
  mithril       Int      @default(0)
  
  fame          Int      @default(0)
  currentRegion Int      @default(1)
  
  heroes        Hero[]
  inventory     InventoryItem[]
  listings      MarketListing[]
  guildId       Int?
  guild         Guild?   @relation(fields: [guildId], references: [id])
  guildRole     String   @default("MEMBER")
  achievements  UserAchievement[]
  recipes       UserRecipe[]
  activeQuests  UserQuest[]
}

// ==========================================
// TEMPLATES & INSTANCE DATA (Preserved)
// ==========================================

model RegionTemplate {
  id              Int      @id
  name            String
  description     String
  type            String   @default("TOWN")
  coordinates     String   @default("{\"x\": 0, \"y\": 0}")
  connections     String   @default("[]")
  environment     String   @default("{}")
  economy         String   @default("{}")
  resourceYield   String   @default("[]")
  encounterPool   String   @default("[]")
  entryReqs       String   @default("{}")
  dangerLevel     Int      @default(1)
  backgroundPath  String   @default("res://assets/backgrounds/default.png")
  musicTrack      String   @default("default_theme")
  filePath        String   @default("regions/misc.json")
  buildings       BuildingInstance[]
}

model BuildingTemplate {
  id              Int      @id
  name            String
  description     String
  category        String   @default("ECONOMY")
  upgradeTree     String   @default("[]")
  perksPerLevel   String   @default("[]")
  staffingLogic   String   @default("{}")
  maintenance     String   @default("{}")
  iconPath        String   @default("res://assets/icons/buildings/default.png")
  modelPath       String   @default("")
  filePath        String   @default("buildings/misc.json")
  instances       BuildingInstance[]
}

model GlobalEventTemplate {
  id              Int      @id
  name            String
  description     String
  category        String   @default("WEATHER")
  triggerType     String   @default("SCHEDULED")
  worldModifiers  String   @default("{}")
  combatModifiers String   @default("{}")
  targetScope     String   @default("GLOBAL")
  iconPath        String   @default("res://assets/icons/events/default.png")
  filePath        String   @default("events/misc.json")
  specialSpawns   EventSpawn[]
}

model EventSpawn {
  id              Int      @id @default(autoincrement())
  eventId         Int
  event           GlobalEventTemplate @relation(fields: [eventId], references: [id])
  monsterId       Int
  spawnChance     Float
  locationId      Int?
}

model QuestTemplate {
  id              Int      @id
  name            String
  description     String
  category        String   @default("SIDE")
  difficulty      String   @default("NORMAL")
  minLevel        Int      @default(1)
  prerequisiteQuestId Int?
  logicBranches   String   @default("{}")
  rewards         String   @default("{}") 
  isTimeLimited   Boolean  @default(false)
  expiryHours     Int      @default(0)
  requiredRegion  Int?
  iconPath        String   @default("res://assets/icons/quests/default.png")
  filePath        String   @default("quests/misc.json")
  objectives      QuestObjective[]
  userQuests      UserQuest[]
}

model QuestObjective {
  id              Int      @id @default(autoincrement())
  questId         Int
  quest           QuestTemplate @relation(fields: [questId], references: [id])
  type            String   
  targetId        Int      
  amount          Int      @default(1)
  description     String
  userProgress    UserQuestObjective[]
}

model ClassTemplate {
  id              Int      @id
  name            String
  description     String
  tier            Int      @default(1)
  statSystem      String   @default("{}")
  masteries       String   @default("{}")
  mechanics       String   @default("{}")
  skillTree       String   @default("[]")
  innateTraits    String   @default("[]")
  promotionReqs   String   @default("{}")
  nextClasses     String   @default("[]")
  iconPath        String   @default("res://assets/icons/classes/default.png")
  filePath        String   @default("classes/misc.json")
  heroes          Hero[]
}

model ItemTemplate {
  id              Int      @id
  name            String
  description     String
  category        String @default("EQUIPMENT")
  subCategory     String @default("MISC")
  baseDurability  Int    @default(100)
  repairCostPerPt Int    @default(1)
  baseStats       String @default("{}")
  requirements    String @default("{}")
  maxSockets      Int    @default(0)
  allowedSockets  String @default("[]")
  setId           Int?
  itemSet         ItemSet? @relation(fields: [setId], references: [id])
  isCraftable     Boolean @default(true)
  salvageResult   String @default("[]")
  rarity          String @default("COMMON")
  iconPath        String @default("res://assets/icons/items/default.png")
  filePath        String @default("items/misc.json")
  instances       InventoryItem[]
  marketListings  MarketListing[]
}

model ItemSet {
  id              Int      @id
  name            String
  description     String
  items           ItemTemplate[]
  bonuses         ItemSetBonus[]
}

model ItemSetBonus {
  id              Int      @id @default(autoincrement())
  setId           Int
  itemSet         ItemSet  @relation(fields: [setId], references: [id])
  requiredCount   Int
  statModifiers   String   @default("{}")
}

model GuildTemplate {
  id              Int      @id
  name            String
  description     String
  basePerks       String   @default("{}")
  progressionTree String   @default("[]")
  creationReqs    String   @default("{}")
  primaryColor    String   @default("#ffffff")
  iconPath        String   @default("res://assets/icons/guilds/default.png")
  filePath        String   @default("guilds/misc.json")
  guilds          Guild[]
}

model TraitTemplate {
  id              Int      @id
  name            String
  description     String
  category        String   @default("GENERAL")
  type            String   @default("NATURAL")
  rarity          String   @default("COMMON")
  statModifiers   String   @default("{}")
  elementalMods   String   @default("{}")
  battleHooks     String   @default("{}")
  requirements    String   @default("{}")
  conflicts       String   @default("[]")
  iconPath        String   @default("res://assets/icons/traits/default.png")
  vfxPath         String   @default("")
  filePath        String   @default("traits/misc.json")
  heroes          HeroTrait[]
}

model BehaviourTemplate {
  id              Int      @id
  name            String
  description     String
  targetWeights   String   @default("{}")
  movementStyle   String   @default("BALANCED")
  tacticTriggers  String   @default("[]")
  cohesionWeight  Float    @default(0.5)
  requirements    String   @default("{}") 
  filePath        String   @default("behaviors/misc.json")
  heroes          HeroBehavior[]
}

model JobTemplate {
  id              Int      @id
  name            String
  description     String
  category        String   @default("COLLECTION")
  workStats       String   @default("{}")
  lootTable       String   @default("[]")
  toolAccess      String   @default("{}")
  masteryRewards  String   @default("{}")
  passiveBonuses  String   @default("{}")
  iconPath        String   @default("res://assets/icons/jobs/default.png")
  filePath        String   @default("jobs/misc.json")
  workers         Hero[]
}

model SkillTemplate {
  id              Int      @id
  name            String
  description     String
  category        String   @default("ATTACK")
  element         String   @default("NEUTRAL")
  manaCost        Int      @default(0)
  staminaCost     Int      @default(0)
  healthCost      Int      @default(0)
  cooldown        Int      @default(3)
  castTime        Int      @default(0)
  damageFormula   String   @default("{}")
  targetType      String   @default("ENEMY")
  aoePattern      String   @default("SINGLE")
  aoeSize         Int      @default(0)
  range           Int      @default(1)
  statusEffects   String   @default("[]")
  vfxPath         String   @default("")
  animationName   String   @default("attack")
  requirements    String   @default("{}")
  filePath        String   @default("skills/misc.json")
}

model StatusEffectTemplate {
  id              Int      @id
  name            String
  description     String
  type            String   @default("DEBUFF")
  element         String   @default("NEUTRAL")
  stackingRule    String   @default("REFRESH") 
  maxStacks       Int      @default(1)
  defaultDuration Int      @default(3)
  tickLogic       String   @default("{}")
  statModifiers   String   @default("{}")
  battleHooks     String   @default("{}")
  iconPath        String   @default("res://assets/icons/effects/default.png")
  vfxPath         String   @default("")
  applyVfxPath    String   @default("")
  filePath        String   @default("effects/misc.json")
}

model AchievementTemplate {
  id              Int      @id
  name            String
  description     String
  category        String   @default("GENERAL")
  points          Int      @default(10)
  requirements    String   @default("{}")
  rewards         String   @default("{}")
  isHidden        Boolean  @default(false)
  iconPath        String   @default("res://assets/icons/achievements/default.png")
  vfxPath         String   @default("")
  filePath        String   @default("achievements/misc.json")
  users           UserAchievement[]
}

model MonsterCategory {
  id        Int      @id
  name      String
  monsters  MonsterTemplate[]
}

model MonsterTemplate {
  id          Int      @id
  name        String
  categoryId  Int
  category    MonsterCategory @relation(fields: [categoryId], references: [id])
  hp_base     Int
  damage_base Int
  defense_base Int
  speed_base  Int
  range_base  Int
  exp_reward  Int
  element     String   @default("NEUTRAL")
  size        String   @default("MEDIUM")
  traits      String   @default("[]")
  skills      String   @default("[]")
  immunities  String   @default("[]")
  lootTable   String   @default("{}")
  filePath    String   @default("monsters/misc.json") 
}

model DialogueTemplate {
  id              Int      @id
  npcId           String
  content         String
  branches        String   @default("[]")
  requirements    String   @default("{}")
  triggers        String   @default("[]")
  mood            String   @default("NEUTRAL")
  portraitPath    String   @default("")
  filePath        String   @default("dialogues/misc.json")
}

model RecipeTemplate {
  id              Int      @id
  name            String
  description     String
  category        String   @default("SMITHING")
  resultItemId    Int
  resultQuantity  Int      @default(1)
  goldCost        Int      @default(0)
  requiredFame    Int      @default(0)
  requiredJobId   Int?  
  minJobLevel     Int      @default(1)
  requiredBuildingId Int? 
  baseSuccessRate Float    @default(1.0)
  filePath        String   @default("recipes/misc.json")
  ingredients     RecipeIngredient[]
  learnedBy       UserRecipe[]
}

model RecipeIngredient {
  id              Int      @id @default(autoincrement())
  recipeId        Int
  recipe          RecipeTemplate @relation(fields: [recipeId], references: [id])
  itemId          Int
  quantity        Int
}

model RaceBonusTemplate {
  id          Int      @id
  bonusData   String 
  filePath    String   @default("races/misc.json")
}

// 3. INSTANCE DATA

model Hero {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  name        String
  race        String
  gender      String   @default("MALE")
  level       Int      @default(1)
  exp         Int      @default(0)
  classId     Int      @default(1001)
  combatClass ClassTemplate @relation(fields: [classId], references: [id])
  jobId       Int?
  job         JobTemplate? @relation(fields: [jobId], references: [id])
  jobLevel    Int      @default(1)
  jobExp      Int      @default(0)
  jobRank     String   @default("APPRENTICE")
  baseStats         String @default("{}")
  activeBehavior    Int    @default(6001)
  deeds             String @default("{}")
  hasReproduced Boolean @default(false)
  fatherId      Int?
  motherId      Int?
  generation    Int      @default(1)
  equipment   String @default("{}")
  createdAt   DateTime @default(now())
  traits      HeroTrait[]
  behaviors   HeroBehavior[]
}

model HeroTrait {
  id          Int      @id @default(autoincrement())
  heroId      Int
  hero        Hero     @relation(fields: [heroId], references: [id])
  traitId     Int
  trait       TraitTemplate @relation(fields: [traitId], references: [id])
  isNatural   Boolean  @default(true)
}

model HeroBehavior {
  id          Int      @id @default(autoincrement())
  heroId      Int
  hero        Hero     @relation(fields: [heroId], references: [id])
  behaviorId  Int
  behavior    BehaviourTemplate @relation(fields: [behaviorId], references: [id])
}

model InventoryItem {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  templateId  Int
  template    ItemTemplate @relation(fields: [templateId], references: [id])
  quantity    Int      @default(1)
  currentDurability Int  @default(100)
  uniqueData  String   @default("{}")
  sockets     String   @default("[]")
  isEquipped  Boolean  @default(false)
  ownerHeroId Int?
  marketListing MarketListing?
}

model BuildingInstance {
  id              Int      @id @default(autoincrement())
  regionId        Int
  region          RegionTemplate @relation(fields: [regionId], references: [id])
  templateId      Int
  template        BuildingTemplate @relation(fields: [templateId], references: [id])
  level           Int      @default(1)
  instanceData    String   @default("{}")
  createdAt       DateTime @default(now())
}

model Guild {
  id              Int      @id @default(autoincrement())
  name            String   @unique
  description     String?
  templateId      Int
  template        GuildTemplate @relation(fields: [templateId], references: [id])
  level           Int    @default(1)
  exp             Int    @default(0)
  vaultGold       Int    @default(0)
  unlockedPerks   String @default("[]")
  facilities      String @default("{}")
  members         User[]
  createdAt       DateTime @default(now())
}

model HallOfFame {
  id          Int      @id @default(autoincrement())
  originalId  Int
  ownerName   String
  name        String
  race        String
  gender      String
  level       Int
  classTier   Int
  generation  Int
  finalDeeds  String
  deathDate   DateTime @default(now())
  causeOfDeath String
}

model MarketListing {
  id              Int      @id @default(autoincrement())
  sellerId        Int
  seller          User     @relation(fields: [sellerId], references: [id])
  templateId      Int
  itemTemplate    ItemTemplate @relation(fields: [templateId], references: [id])
  itemInstanceId  Int      @unique
  itemInstance    InventoryItem @relation(fields: [itemInstanceId], references: [id])
  pricePerUnit    Int
  totalPrice      Int      
  createdAt       DateTime @default(now())
  expiresAt       DateTime
  isSold          Boolean  @default(false)
}

model MarketHistory {
  id              Int      @id @default(autoincrement())
  templateId      Int
  quantity        Int
  soldPrice       Int
  taxPaid         Int      @default(0)
  soldAt          DateTime @default(now())
  buyerId         Int
  sellerId        Int
}

model UserAchievement {
  id            Int      @id @default(autoincrement())
  userId        Int
  user          User     @relation(fields: [userId], references: [id])
  achievementId Int
  achievement   AchievementTemplate @relation(fields: [achievementId], references: [id])
  progress      Int      @default(0)
  isUnlocked    Boolean  @default(false)
  unlockedAt    DateTime?
  @@unique([userId, achievementId])
}

model UserRecipe {
  id            Int      @id @default(autoincrement())
  userId        Int
  user          User     @relation(fields: [userId], references: [id])
  recipeId      Int
  recipe        RecipeTemplate @relation(fields: [recipeId], references: [id])
  craftCount    Int      @default(0)
  masteryLevel  Int      @default(1)
  masteryExp    Int      @default(0)
  isDiscovered  Boolean  @default(true)
  unlockedAt    DateTime @default(now())
  @@unique([userId, recipeId])
}

model UserQuest {
  id            Int      @id @default(autoincrement())
  userId        Int
  user          User     @relation(fields: [userId], references: [id])
  questId       Int
  quest         QuestTemplate @relation(fields: [questId], references: [id])
  status        String   @default("ACTIVE")
  acceptedAt    DateTime @default(now())
  completedAt   DateTime?
  objectives    UserQuestObjective[]
  @@unique([userId, questId])
}

model UserQuestObjective {
  id            Int      @id @default(autoincrement())
  userQuestId   Int
  userQuest     UserQuest @relation(fields: [userQuestId], references: [id])
  objectiveId   Int
  objective     QuestObjective @relation(fields: [objectiveId], references: [id])
  currentAmount Int      @default(0)
  isCompleted   Boolean  @default(false)
  @@unique([userQuestId, objectiveId])
}

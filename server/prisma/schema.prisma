// AAA Deep Town Building & Infrastructure Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ... (User, Hero, Guild, Item, Quest, Event, Region preserved) ...

model User {
  id            String   @id @default(uuid())
  username      String   @unique
  password      String
  gold          Int      @default(500)
  fame          Int      @default(0)
  currentRegion String   @default("starting_village")
  
  heroes        Hero[]
  inventory     InventoryItem[]
  
  guildId       String?
  guild         Guild?   @relation(fields: [guildId], references: [id])
  guildRole     String   @default("MEMBER")
}

// ========================================== 
// NEW: TOWN BUILDING SYSTEM
// ========================================== 

model BuildingTemplate {
  id              String @id
  name            String
  description     String
  category        String   @default("ECONOMY") // ECONOMY, MILITARY, MAGIC, SOCIAL
  
  // 1. Upgrade Logic (JSON Array)
  // Define costs and requirements for each level
  // e.g., [{"level": 2, "cost": {"gold": 1000}, "req_building": "town_hall_1"}]
  upgradeTree     String   @default("[]")
  
  // 2. Functional Perks (JSON Array)
  // Define what each level provides
  // e.g., [{"level": 5, "perk": "unlock_vampire_race"}, {"level": 10, "perk": "tax_bonus_5"}]
  perksPerLevel   String   @default("[]")
  
  // 3. Staffing Requirements (JSON)
  // e.g., {"required_job": "job_miner", "min_job_level": 10}
  staffingLogic   String   @default("{}")
  
  // 4. Maintenance (JSON)
  // Costs incurred per world-clock cycle
  // e.g., {"gold_cost": 50, "materials": [{"id": "wood", "qty": 5}]}
  maintenance     String   @default("{}")
  
  // 5. Assets
  iconPath        String   @default("res://assets/icons/buildings/default.png")
  modelPath       String   @default("") // Godot 3D/2D scene
  filePath        String   @default("buildings/misc.json")
  
  instances       BuildingInstance[]
}

model BuildingInstance {
  id              String @id @default(uuid())
  regionId        String
  region          RegionTemplate @relation(fields: [regionId], references: [id])
  
  templateId      String
  template        BuildingTemplate @relation(fields: [templateId], references: [id])
  
  level           Int      @default(1)
  
  // Dynamic State (JSON)
  // e.g., {"is_ruined": false, "assigned_hero_ids": ["uuid1"]}
  instanceData    String   @default("{}")
  
  createdAt       DateTime @default(now())
}

// ========================================== 
// PRESERVED MASTER TABLES
// ========================================== 

model RegionTemplate {
  id              String @id
  name            String
  description     String
  type            String   @default("TOWN")
  coordinates     String   @default("{\"x\": 0, \"y\": 0}")
  connections     String   @default("[]")
  environment     String   @default("{}")
  economy         String   @default("{}")
  resourceYield   String   @default("[]")
  encounterPool   String   @default("[]")
  entryReqs       String   @default("{}")
  dangerLevel     Int      @default(1)
  backgroundPath  String   @default("res://assets/backgrounds/default.png")
  musicTrack      String   @default("default_theme")
  filePath        String   @default("regions/misc.json")
  
  buildings       BuildingInstance[]
}

model GlobalEventTemplate {
  id              String @id
  name            String
  description     String
  category        String @default("WEATHER")
  triggerType     String @default("SCHEDULED")
  worldModifiers  String @default("{}")
  combatModifiers String @default("{}")
  specialSpawns   String @default("[]")
  targetScope     String @default("GLOBAL")
  iconPath        String @default("res://assets/icons/events/default.png")
  filePath        String @default("events/misc.json")
}

model QuestTemplate {
  id              String @id
  name            String
  description     String
  category        String @default("SIDE")
  difficulty      String @default("NORMAL")
  minLevel        Int    @default(1)
  prerequisiteQuestId String?
  objectives      String @default("[]")
  logicBranches   String @default("{}")
  rewards         String @default("{}")
  isTimeLimited   Boolean @default(false)
  expiryHours     Int     @default(0)
  requiredRegion  String?
  iconPath        String @default("res://assets/icons/quests/default.png")
  filePath        String @default("quests/misc.json")
}

model ClassTemplate {
  id              String @id
  name            String
  description     String
  tier            Int    @default(1)
  statSystem      String @default("{}")
  masteries       String @default("{}")
  mechanics       String @default("{}")
  skillTree       String @default("[]")
  innateTraits    String @default("[]")
  promotionReqs   String @default("{}")
  nextClasses     String @default("[]")
  iconPath        String @default("res://assets/icons/classes/default.png")
  filePath        String @default("classes/misc.json")
  heroes          Hero[]
}

model ItemTemplate {
  id              String @id
  name            String
  description     String
  category        String @default("EQUIPMENT")
  subCategory     String @default("MISC")
  baseStats       String @default("{}")
  requirements    String @default("{}")
  maxSockets      Int    @default(0)
  allowedSockets  String @default("[]")
  setId           String?
  itemSet         ItemSet? @relation(fields: [setId], references: [id])
  isCraftable     Boolean @default(true)
  salvageResult   String @default("[]")
  rarity          String @default("COMMON")
  iconPath        String @default("res://assets/icons/items/default.png")
  filePath        String @default("items/misc.json")
  instances       InventoryItem[]
}

model ItemSet {
  id              String @id
  name            String
  description     String
  setBonuses      String @default("[]")
  items           ItemTemplate[]
}

model ItemAffix {
  id              String @id
  name            String
  type            String @default("PREFIX")
  modifiers       String @default("{}")
  allowedCategories String @default("[]")
  minItemLevel      Int    @default(1)
  rarity            String @default("COMMON")
}

model GuildTemplate {
  id              String @id
  name            String
  description     String
  basePerks       String @default("{}")
  progressionTree String @default("[]")
  creationReqs    String @default("{}")
  primaryColor    String @default("#ffffff")
  iconPath        String @default("res://assets/icons/guilds/default.png")
  filePath        String @default("guilds/misc.json")
  guilds          Guild[]
}

model Guild {
  id              String @id @default(uuid())
  name            String @unique
  description     String?
  templateId      String
  template        GuildTemplate @relation(fields: [templateId], references: [id])
  level           Int    @default(1)
  exp             Int    @default(0)
  vaultGold       Int    @default(0)
  unlockedPerks   String @default("[]")
  facilities      String @default("{}")
  members         User[]
  createdAt       DateTime @default(now())
}

model Hero {
  id          String @id @default(uuid())
  userId      String
  user        User   @relation(fields: [userId], references: [id])
  name        String
  race        String
  gender      String   @default("MALE")
  level       Int      @default(1)
  exp         Int      @default(0)
  classId     String   @default("class_novice")
  combatClass ClassTemplate @relation(fields: [classId], references: [id])
  classTier   Int      @default(1)
  jobId       String?
  job         JobTemplate? @relation(fields: [jobId], references: [id])
  jobLevel    Int      @default(1)
  jobExp      Int      @default(0)
  jobRank     String   @default("APPRENTICE")
  baseStats         String @default("{}")
  naturalTraits     String @default("[]")
  acquiredTraits    String @default("[]")
  unlockedBehaviors String @default("[]")
  activeBehavior    String @default("balanced")
  deeds             String @default("{}")
  hasReproduced Boolean @default(false)
  fatherId      String?
  motherId      String?
  generation    Int      @default(1)
  equipment   String @default("{}")
  createdAt   DateTime @default(now())
}

model JobTemplate {
  id              String @id
  name            String
  description     String
  category        String @default("COLLECTION")
  workStats       String @default("{}")
  lootTable       String @default("[]")
  toolAccess      String @default("{}")
  masteryRewards  String @default("{}")
  passiveBonuses  String @default("{}")
  iconPath        String @default("res://assets/icons/jobs/default.png")
  filePath        String @default("jobs/misc.json")
  workers         Hero[]
}

model SkillTemplate {
  id              String @id
  name            String
  description     String
  category        String @default("ATTACK")
  element         String @default("NEUTRAL")
  manaCost        Int    @default(0)
  staminaCost     Int    @default(0)
  healthCost      Int    @default(0)
  cooldown        Int    @default(3)
  castTime        Int    @default(0)
  damageFormula   String @default("{}")
  targetType      String @default("ENEMY")
  aoePattern      String @default("SINGLE")
  aoeSize         Int    @default(0)
  range           Int    @default(1)
  statusEffects   String @default("[]")
  vfxPath         String @default("")
  animationName   String @default("attack")
  requirements    String @default("{}")
  filePath        String @default("skills/misc.json")
}

model TraitTemplate {
  id              String @id
  name            String
  description     String
  category        String @default("GENERAL")
  type            String @default("NATURAL")
  rarity          String @default("COMMON")
  statModifiers   String @default("{}")
  elementalMods   String @default("{}")
  battleHooks     String @default("{}")
  requirements    String @default("{}")
  conflicts       String @default("[]")
  iconPath        String @default("res://assets/icons/traits/default.png")
  vfxPath         String @default("")
  filePath        String @default("traits/misc.json")
}

model BehaviourTemplate {
  id              String @id
  name            String
  description     String
  targetWeights   String @default("{}")
  movementStyle   String @default("BALANCED")
  tacticTriggers  String @default("[]")
  cohesionWeight  Float  @default(0.5)
  requirements    String @default("{}") 
  filePath        String @default("behaviors/misc.json")
}

model MonsterCategory {
  id        String @id
  name      String
  monsters  MonsterTemplate[]
}

model MonsterTemplate {
  id          String @id
  name        String
  categoryId  String
  category    MonsterCategory @relation(fields: [categoryId], references: [id])
  hp_base     Int
  damage_base Int
  defense_base Int
  speed_base  Int
  range_base  Int
  exp_reward  Int
  element     String @default("NEUTRAL")
  size        String @default("MEDIUM")
  traits      String @default("[]")
  skills      String @default("[]")
  immunities  String @default("[]")
  lootTable   String @default("{}")
  filePath    String @default("monsters/misc.json") 
}

model HallOfFame {
  id          String @id @default(uuid())
  originalId  String
  ownerName   String
  name        String
  race        String
  gender      String
  level       Int
  classTier   Int
  generation  Int
  finalDeeds  String
  deathDate   DateTime @default(now())
  causeOfDeath String
}

model InventoryItem {
  id          String @id @default(uuid())
  userId      String
  user        User   @relation(fields: [userId], references: [id])
  templateId  String
  template    ItemTemplate @relation(fields: [templateId], references: [id])
  
  quantity    Int    @default(1)
  uniqueData  String @default("{}")
  sockets     String @default("[]")
  isEquipped  Boolean @default(false)
  ownerHeroId String?
}

model RaceBonusTemplate {
  id          String @id
  bonusData   String 
  filePath    String @default("races/misc.json")
}
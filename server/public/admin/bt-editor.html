<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Textical AI Architect v4.5 (Advanced Parameters)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { background-color: #020408; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; }
        .node rect { stroke-width: 2px; rx: 10; ry: 10; fill: #1e293b; stroke: #334155; }
        .node--selected rect { stroke: #fbbf24 !important; stroke-width: 3px; filter: drop-shadow(0 0 12px #fbbf24); }
        .node text { font-size: 11px; font-family: 'JetBrains Mono', monospace; fill: #f1f5f9; pointer-events: none; }
        .link { fill: none; stroke: #1e293b; stroke-width: 2px; }
        .link-yes { stroke: #10b981; stroke-dasharray: 4,4; }
        .link-no { stroke: #ef4444; stroke-dasharray: 4,4; }
        .sidebar { background: rgba(10, 15, 25, 0.98); border-right: 1px solid #1e293b; }
        input, select, textarea { background: #05070a; border: 1px solid #1e293b; color: white; padding: 10px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; width: 100%; font-size: 13px; }
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; text-transform: uppercase; font-size: 12px; }
        .btn-primary { background: linear-gradient(135deg, #0ea5e9, #2563eb); color: white; }
        #toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 30px; border-radius: 10px; background: #059669; transform: translateY(100px); transition: 0.4s; z-index: 100; }
        #toast.show { transform: translateY(0); }
    </style>
</head>
<body class="h-screen w-screen flex">
    <div id="toast">Reality Reconfigured</div>

    <!-- LEFT: Tools -->
    <div class="w-80 h-full sidebar p-6 flex flex-col gap-6 z-10 overflow-hidden shadow-2xl">
        <h1 class="text-xl font-black text-sky-400 italic">ADVANCED AI</h1>
        <div class="space-y-2">
            <select id="treeSelector" onchange="loadSelectedTree()" class="text-sm font-bold"></select>
            <button class="w-full text-[10px] text-sky-400 text-left hover:underline" onclick="createNewTree()">+ FORGE NEW VESSEL</button>
        </div>
        <hr class="border-slate-800">
        
        <div id="inspector" class="flex-1 overflow-y-auto space-y-6 hidden">
            <h2 class="text-xs font-bold text-sky-400 uppercase tracking-widest">Node Properties</h2>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] text-slate-500 uppercase font-bold">Label</label>
                    <input type="text" id="nodeTitle" oninput="updateNode()">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] text-slate-500 uppercase font-bold">Implementation</label>
                    <select id="nodeClass" onchange="updateNode()">
                        <option value="Priority">LIST (Priority)</option>
                        <option value="Switch">SWITCH (Sequence)</option>
                        <optgroup label="Conditions (If)">
                            <option value="CheckHealth">CheckHealth (HP %)</option>
                            <option value="CheckMana">CheckMana (MP %)</option>
                            <option value="HasStatusEffect">HasStatusEffect (Cek Status)</option>
                            <option value="IsTargetInRange">IsTargetInRange</option>
                        </optgroup>
                        <optgroup label="Actions (Do)">
                            <option value="FindTarget">FindTarget (Select Target)</option>
                            <option value="AttackTarget">AttackTarget</option>
                            <option value="MoveToTarget">MoveToTarget</option>
                            <option value="UseSkill">UseSkill (Gunakan Skill ID)</option>
                        </optgroup>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] text-slate-500 uppercase font-bold">Parameters (JSON)</label>
                    <textarea id="nodeProps" rows="4" oninput="updateNode()" placeholder='{ "threshold": 0.5 }'></textarea>
                    <p class="text-[9px] text-slate-600 mt-1">Contoh: { "threshold": 0.5 } atau { "strategy": "ALLIES" }</p>
                </div>
            </div>
            <div class="pt-4 border-t border-slate-800 space-y-2" id="branchControls">
                <button class="btn border border-emerald-900/50 text-emerald-400 w-full" onclick="addChild(0)">+ ADD 'YES' BRANCH</button>
                <button class="btn border border-red-900/50 text-red-400 w-full" onclick="addChild(1)">+ ADD 'ELSE' BRANCH</button>
                <button id="stdAdd" class="btn border border-sky-900/50 text-sky-400 w-full" onclick="addChild()">+ ATTACH CHILD</button>
            </div>
            <button onclick="deleteNode()" class="text-red-500 text-[10px] uppercase font-bold hover:underline">Destroy Node</button>
        </div>

        <div class="pt-4 border-t border-slate-800">
            <button class="btn btn-primary w-full" onclick="saveTree()">SYNC TO SERVER</button>
        </div>
    </div>

    <!-- CENTER: Canvas -->
    <div id="canvas" class="flex-1 h-full relative bg-[#020408]">
        <div class="absolute top-8 left-8 pointer-events-none select-none">
            <p id="treeTitle" class="text-4xl font-black text-slate-900 uppercase italic tracking-tighter"></p>
        </div>
    </div>

    <script>
        let currentTree = null, selectedNodeId = null, svg, g, zoom;

        async function init() {
            const res = await fetch('/admin/api/bt/list');
            const list = await res.json();
            const selector = document.getElementById('treeSelector');
            selector.innerHTML = '<option value="">Choose Vessel...</option>';
            list.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name; opt.textContent = name.toUpperCase();
                selector.appendChild(opt);
            });
            setupCanvas();
        }

        function setupCanvas() {
            zoom = d3.zoom().scaleExtent([0.1, 3]).on("zoom", (e) => g.attr("transform", e.transform));
            svg = d3.select("#canvas").append("svg").attr("width", "100%").attr("height", "100%").call(zoom);
            g = svg.append("g");
        }

        async function loadSelectedTree() {
            const name = document.getElementById('treeSelector').value;
            if (!name) return;
            const res = await fetch(`/admin/api/bt/${name}`);
            currentTree = await res.json();
            document.getElementById('treeTitle').textContent = currentTree.title;
            selectedNodeId = null;
            render();
        }

        function render() {
            if (!currentTree) return;
            g.selectAll("*").remove();

            const hierarchy = d3.hierarchy(buildHierarchy(currentTree.root, currentTree.nodes));
            const treeLayout = d3.tree().nodeSize([250, 150]);
            treeLayout(hierarchy);

            const t = g.transition().duration(400);

            // LINKS
            g.selectAll(".link").data(hierarchy.links()).enter().append("path")
                .attr("class", d => {
                    const parent = currentTree.nodes[d.source.data.id];
                    if (parent.name === "CheckHealth" || parent.name === "IsTargetInRange") {
                        const idx = parent.children.indexOf(d.target.data.id);
                        return idx === 0 ? "link link-yes" : "link link-no";
                    }
                    return "link";
                })
                .attr("d", d => `M ${d.source.x} ${d.source.y + 25} V ${(d.source.y + d.target.y) / 2} H ${d.target.x} V ${d.target.y - 25}`);

            // NODES
            const nodes = g.selectAll(".node").data(hierarchy.descendants()).enter().append("g")
                .attr("transform", d => `translate(${d.x},${d.y})`)
                .on("click", (e, d) => { e.stopPropagation(); selectNode(d.data.id); });

            nodes.append("rect").attr("width", 180).attr("height", 50).attr("x", -90).attr("y", -25)
                 .style("stroke", d => d.data.id === selectedNodeId ? "#fbbf24" : "#334155");
            nodes.append("text").attr("text-anchor", "middle").attr("dy", 5).text(d => d.data.title);
        }

        function buildHierarchy(id, map) {
            const n = map[id];
            return { id, title: n.title || n.name, name: n.name, children: (n.children || []).map(cid => buildHierarchy(cid, map)) };
        }

        function selectNode(id) {
            selectedNodeId = id;
            const node = currentTree.nodes[id];
            document.getElementById('inspector').classList.remove('hidden');
            document.getElementById('nodeTitle').value = node.title || "";
            document.getElementById('nodeClass').value = node.name;
            document.getElementById('nodeProps').value = JSON.stringify(node.properties || {}, null, 2);

            const isIf = node.name === "CheckHealth" || node.name === "IsTargetInRange";
            document.getElementById('addThenBtn').style.display = isIf ? "block" : "none"; // Oops fixed below
            render();
        }

        function updateNode() {
            if (!selectedNodeId) return;
            const node = currentTree.nodes[selectedNodeId];
            node.title = document.getElementById('nodeTitle').value;
            node.name = document.getElementById('nodeClass').value;
            try { node.properties = JSON.parse(document.getElementById('nodeProps').value); } catch(e) {}
            render();
        }

        function addChild(idx = -1) {
            if (!selectedNodeId) return;
            const node = currentTree.nodes[selectedNodeId];
            const newId = 'node-' + Math.random().toString(36).substr(2, 9);
            currentTree.nodes[newId] = { id: newId, name: 'AttackTarget', title: 'New Action', children: [], properties: {} };
            if (!node.children) node.children = [];
            if (idx !== -1) node.children[idx] = newId; else node.children.push(newId);
            render();
        }

        async function saveTree() {
            const name = document.getElementById('treeSelector').value;
            await fetch(`/admin/api/bt/${name}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(currentTree)
            });
            const toast = document.getElementById('toast');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        init();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Textical Aegis Debug Lab v4.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { background-color: #020408; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(56, 189, 248, 0.1); }
        
        canvas { background-color: #05070a; border: 1px solid #1e293b; image-rendering: pixelated; }
        
        .log-line { border-left: 2px solid transparent; transition: all 0.2s; cursor: pointer; }
        .log-MOVE { border-color: #64748b; color: #94a3b8; }
        .log-ATTACK, .log-DAMAGE { border-color: #ef4444; color: #f87171; font-weight: bold; }
        .log-HEAL { border-color: #10b981; color: #34d399; }
        .log-CAST_SKILL { border-color: #38bdf8; color: #7dd3fc; }
        .log-TRAIT { border-color: #8b5cf6; color: #a78bfa; font-style: italic; }
        
        input[type=range] { -webkit-appearance: none; background: #1e293b; height: 4px; border-radius: 5px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #38bdf8; cursor: pointer; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col p-6 gap-4">

    <!-- TOP: Controls -->
    <div class="glass p-4 rounded-2xl flex justify-between items-center shadow-2xl">
        <div class="flex items-center gap-4">
            <h1 class="text-lg font-black tracking-tighter uppercase">Aegis <span class="text-sky-400">Lab v4.1</span></h1>
            <div class="flex-1 min-w-[300px] px-4">
                <input type="range" id="timeline" min="0" max="0" value="0" oninput="jumpToTick(this.value)" class="w-full">
                <div id="timelineLabel" class="text-[9px] mono text-center text-slate-500 mt-1">TICK 0 / 0</div>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="toggleAuto()" id="playBtn" class="bg-indigo-600 px-6 py-2 rounded-xl font-black text-xs">PLAY</button>
            <button onclick="runBattle()" class="bg-sky-600 hover:bg-sky-500 px-6 py-2 rounded-xl font-bold text-xs">FORGE BATTLE</button>
        </div>
    </div>

    <div class="flex-1 flex gap-4 overflow-hidden">
        
        <!-- LEFT: Forge -->
        <div class="w-72 flex flex-col gap-4">
            <div class="glass flex-1 p-5 rounded-2xl flex flex-col overflow-hidden">
                <h2 class="text-[10px] font-black text-slate-500 uppercase mb-4">Unit Deployment</h2>
                <div id="unitForge" class="flex-1 overflow-y-auto space-y-3 pr-2"></div>
                <button onclick="addDefaultUnit()" class="mt-4 w-full border border-dashed border-slate-700 p-2 rounded-xl text-[10px] font-bold text-slate-500 hover:text-sky-400">+ SPAWN</button>
            </div>
        </div>

        <!-- CENTER: Tactical Grid -->
        <div class="flex-1 glass rounded-3xl p-6 flex flex-col items-center justify-center relative">
            <canvas id="battleGrid" width="550" height="550" class="rounded-lg shadow-2xl"></canvas>
            
            <!-- Floating Data Box -->
            <div id="unitDataBox" class="absolute bottom-10 left-10 p-4 bg-black/60 backdrop-blur rounded-xl border border-slate-800 text-[10px] mono hidden"></div>
        </div>

        <!-- RIGHT: Neural Console -->
        <div class="w-96 flex flex-col gap-4">
            <div class="glass flex-1 p-6 rounded-2xl flex flex-col overflow-hidden">
                <h2 class="text-[10px] font-black text-sky-400 uppercase tracking-widest mb-4">Neural Sequence</h2>
                <div id="eventLog" class="flex-1 overflow-y-auto space-y-1 pr-2"></div>
            </div>
        </div>

    </div>

    <script>
        let sandboxUnits = [];
        let replayData = [];
        let currentTickIdx = 0;
        let isPlaying = false;
        let playInterval = null;

        const canvas = document.getElementById('battleGrid');
        const ctx = canvas.getContext('2d');
        const cellSize = 11;

        function addDefaultUnit() {
            const team = sandboxUnits.filter(u => u.team === 0).length >= 2 ? 1 : 0;
            const u = {
                id: "u_" + Math.random().toString(36).substr(2, 4),
                name: team === 0 ? "Hero " + (sandboxUnits.length + 1) : "Enemy " + (sandboxUnits.length + 1),
                team: team,
                traits: team === 0 ? ["vampire", "arcanemaster"] : ["skeleton", "giant"],
                bt_tree: "SimpleAI",
                pos: { x: team === 0 ? 10 + (sandboxUnits.length * 2) : 40, y: 25 },
                stats: { health_max: 100, mana_max: 50, attack_damage: 20, defense: 5, speed: 10, attack_range: 1, dodge_rate: 5, crit_chance: 0.1, crit_damage: 1.5 }
            };
            sandboxUnits.push(u);
            updateForgeUI();
        }

        function updateForgeUI() {
            const forge = document.getElementById('unitForge');
            forge.innerHTML = "";
            sandboxUnits.forEach((u, idx) => {
                const div = document.createElement('div');
                div.className = "p-3 bg-black/20 rounded-xl border border-slate-800 text-[10px]";
                div.innerHTML = `
                    <div class="font-bold text-sky-400 mb-1">${u.name}</div>
                    <div class="text-slate-500">T:${u.team} | ${u.traits.join(', ')}</div>
                `;
                forge.appendChild(div);
            });
        }

        async function runBattle() {
            const res = await fetch('/api/debug/run-test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ customUnits: sandboxUnits })
            });
            const data = await res.json();
            replayData = data.replay;
            currentTickIdx = 0;
            document.getElementById('timeline').max = replayData.length - 1;
            renderTick();
        }

        function renderTick() {
            const tick = replayData[currentTickIdx];
            if (!tick) return;

            document.getElementById('timelineLabel').textContent = `TICK ${tick.tick} / ${replayData.length - 1}`;
            document.getElementById('timeline').value = currentTickIdx;

            // --- 1. BASE GRID ---
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = "#0f172a";
            ctx.lineWidth = 0.5;
            for(let i=0; i<50; i++) {
                ctx.beginPath(); ctx.moveTo(i*cellSize, 0); ctx.lineTo(i*cellSize, 550); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, i*cellSize); ctx.lineTo(550, i*cellSize); ctx.stroke();
            }

            // --- 2. UNITS ---
            tick.units.forEach(u => {
                const x = u.pos.x * cellSize; const y = u.pos.y * cellSize;
                ctx.fillStyle = u.team === 0 ? "#38bdf8" : "#ef4444";
                if (u.hp <= 0) ctx.fillStyle = "#1e293b";
                
                ctx.beginPath(); ctx.roundRect(x + 1, y + 1, cellSize - 2, cellSize - 2, 2); ctx.fill();

                if (u.hp > 0) {
                    ctx.fillStyle = "#ef4444"; ctx.fillRect(x, y - 2, cellSize, 1.5);
                    ctx.fillStyle = "#10b981"; ctx.fillRect(x, y - 2, cellSize * (u.hp / u.maxHp), 1.5);
                }
            });

            // --- 3. VISUAL LOGS (THE "JUICE") ---
            tick.events.forEach(e => {
                // Visualize DAMAGE
                if (e.type === "DAMAGE" || e.type === "ATTACK") {
                    const victim = tick.units.find(u => u.id === e.data.target_id);
                    if (victim) {
                        const vx = victim.pos.x * cellSize; const vy = victim.pos.y * cellSize;
                        ctx.fillStyle = "#ef4444";
                        ctx.font = "bold 9px JetBrains Mono";
                        ctx.fillText(`-${e.data.damage || ''}`, vx, vy - 5);
                        
                        // Hit Flash
                        ctx.fillStyle = "rgba(255, 255, 255, 0.3)";
                        ctx.fillRect(vx, vy, cellSize, cellSize);
                    }
                }

                // Visualize MOVE (Draw Trail)
                if (e.type === "MOVE") {
                    ctx.setLineDash([2, 2]);
                    ctx.strokeStyle = "rgba(56, 189, 248, 0.4)";
                    ctx.beginPath();
                    ctx.moveTo(e.data.from.x * cellSize + 5, e.data.from.y * cellSize + 5);
                    ctx.lineTo(e.data.to.x * cellSize + 5, e.data.to.y * cellSize + 5);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }

                // Visualize MISS
                if (e.type === "MISS") {
                    const victim = tick.units.find(u => u.id === e.data.target_id);
                    if (victim) {
                        ctx.fillStyle = "#94a3b8";
                        ctx.font = "bold 8px JetBrains Mono";
                        ctx.fillText("MISS", victim.pos.x * cellSize, victim.pos.y * cellSize - 5);
                    }
                }
            });

            // --- 4. TEXT LOGS ---
            const log = document.getElementById('eventLog');
            log.innerHTML = "";
            tick.events.forEach(e => {
                const div = document.createElement('div');
                div.className = `log-line p-2 rounded text-[10px] mono log-${e.type}`;
                div.textContent = `[${e.type}] ${e.msg}`;
                log.appendChild(div);
            });
            log.scrollTop = log.scrollHeight;
        }

        function jumpToTick(v) { currentTickIdx = parseInt(v); renderTick(); }
        function nextTick() { if (currentTickIdx < replayData.length - 1) { currentTickIdx++; renderTick(); } else if (isPlaying) toggleAuto(); }
        function toggleAuto() {
            isPlaying = !isPlaying;
            document.getElementById('playBtn').textContent = isPlaying ? "PAUSE" : "PLAY";
            if (isPlaying) playInterval = setInterval(nextTick, 100);
            else clearInterval(playInterval);
        }

        addDefaultUnit(); addDefaultUnit();
    </script>
</body>
</html>
